<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steganography</title>
  </head>
  <body>
    <input type="file" id="imageInput" />
    <p>Dữ liệu ảnh:</p>
    <img id="imageDisplay" />
    <pre id="imageDataDisplay"></pre>
    <p>Dữ liệu cần dấu:</p>
    <textarea id="messageInput" rows="4" cols="50"></textarea>
    <button onclick="encodeMessage()">Ẩn tin</button>
    <p>Dữ liệu ảnh kèm chuỗi cần giấu trong ảnh:</p>
    <img id="encodedImageDisplay" />
    <p>Giải mã ảnh:</p>
    <button onclick="decodeImage()">Giải mã</button>
    <p>Nguồn ban đầu của ảnh:</p>
    <img id="originalImageDisplay" />
    <p>Chuỗi cần ẩn dấu ban đầu:</p>
    <p id="originalMessageDisplay"></p>
    <pre id="decodedMessageDisplay"></pre>

    <script>
      function messageToBinary(message) {
        return message
          .split("")
          .map((char) => char.charCodeAt(0).toString(2).padStart(8, "0"))
          .join("");
      }

      function binaryToMessage(binary) {
        return binary
          .match(/.{1,8}/g)
          .map((byte) => String.fromCharCode(parseInt(byte, 2)))
          .join("");
      }

      function encodeMessage() {
        const imageInput = document.getElementById("imageInput");
        const messageInput = document.getElementById("messageInput").value;

        const reader = new FileReader();
        reader.onload = function (event) {
          const image = new Image();
          image.src = event.target.result;
          image.onload = function () {
            const canvas = document.createElement("canvas");
            canvas.width = image.width;
            canvas.height = image.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(image, 0, 0);

            const imageData = ctx.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const binaryMessage = messageToBinary(messageInput);
            const binaryLength = binaryMessage.length;

            let binaryIndex = 0;
            for (let i = 0; i < imageData.data.length; i += 4) {
              if (binaryIndex < binaryLength) {
                const binaryChar = binaryMessage.charAt(binaryIndex);
                let alpha = imageData.data[i + 3];
                alpha = (alpha & ~1) | parseInt(binaryChar);
                imageData.data[i + 3] = alpha;
                binaryIndex++;
              } else {
                break;
              }
            }

            ctx.putImageData(imageData, 0, 0);
            const encodedImageDisplay = document.getElementById(
              "encodedImageDisplay"
            );
            encodedImageDisplay.src = canvas.toDataURL();

            // Hiển thị dữ liệu nhị phân của ảnh
            const imageDataDisplay =
              document.getElementById("imageDataDisplay");
            // Xâu ký tự nhị phân từ giá trị alpha của mỗi pixel
            let binaryImageData = "";
            for (let i = 0; i < imageData.data.length; i += 4) {
              binaryImageData += (imageData.data[i + 3] & 1).toString();
            }
            imageDataDisplay.textContent = binaryImageData;
          };
        };
        reader.readAsDataURL(imageInput.files[0]);
      }

      function decodeImage() {
        const encodedImageDisplay = document.getElementById(
          "encodedImageDisplay"
        );
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const image = new Image();
        image.src = encodedImageDisplay.src;
        image.onload = function () {
          canvas.width = image.width;
          canvas.height = image.height;
          ctx.drawImage(image, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          let binaryMessage = "";
          // Lựa chọn ngẫu nhiên các pixel để lấy giá trị alpha
          const pixels = [];
          for (let i = 0; i < imageData.data.length; i += 4) {
            pixels.push(i / 4);
          }
          shuffleArray(pixels); // Hàm này sẽ xáo trộn mảng pixels

          pixels.forEach((pixelIndex) => {
            binaryMessage += imageData.data[pixelIndex * 4 + 3] & 1;
          });

          const decodedMessage = binaryToMessage(binaryMessage);

          // Hiển thị ảnh và chuỗi cần dấu ban đầu
          const imageInput = document.getElementById("imageInput");
          const originalImageDisplay = document.getElementById(
            "originalImageDisplay"
          );
          originalImageDisplay.src = URL.createObjectURL(imageInput.files[0]);

          const originalMessageDisplay = document.getElementById(
            "originalMessageDisplay"
          );
          originalMessageDisplay.textContent = `${
            document.getElementById("messageInput").value
          }`;

          // Hiển thị dữ liệu nhị phân của ảnh
          const imageDataDisplay = document.getElementById("imageDataDisplay");
          let binaryImageData = "";
          for (let i = 0; i < imageData.data.length; i += 4) {
            binaryImageData += (imageData.data[i + 3] & 1).toString();
          }
          imageDataDisplay.textContent = binaryImageData;

          // Hiển thị chuỗi dấu
          const decodedMessageDisplay = document.getElementById(
            "decodedMessageDisplay"
          );
          decodedMessageDisplay.textContent = decodedMessage;
        };
      }

      // Hàm xáo trộn mảng
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }
    </script>
  </body>
</html>
